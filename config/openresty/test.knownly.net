server {
    listen 80;
    server_name test.knownly.net "";
    server_tokens off;
    more_set_headers 'Server: Knownly.net (TEST)';

    access_log  /sites/knownly/logs/nginx_access.log sitelog;
    error_log  /sites/knownly/logs/nginx_error.log;

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://127.0.0.1:8201;
    }

    location ~* ^/dropbox_redirect/(?<dropbox_path>.*) {
        internal;
        resolver 8.8.8.8; # DNS must be specified to resolve external URLs
        access_log  /sites/knownly/logs/nginx_access.log upstreamlog;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_pass_request_headers off;

        # Always proxy to GET method; Do not use local disk for storing the request
        # =========================================================================
        proxy_method GET;
        proxy_buffering off;
        proxy_pass_request_body off;
        proxy_max_temp_file_size 0;

        # Add auth and cache-control headers
        # ==================================
        set $xauth_temp $upstream_http_authorization;
        proxy_set_header Authorization $xauth_temp;
        set $cache_control_tmp $upstream_http_cache_control;
        proxy_set_header Cache-Control $cache_control_tmp;

        # Hide dropbox and other sensitive response headers
        # =================================================
        proxy_hide_header content-security-policy;
        proxy_hide_header content-security-policy-report-only;
        proxy_hide_header x-content-security-policy;
        proxy_hide_header x-server-response-time;
        proxy_hide_header x-dropbox-request-id;
        proxy_hide_header X-RequestId;
        proxy_hide_header x-dropbox-metadata;
        proxy_hide_header x-robots-tag;
        proxy_hide_header x-webkit-csp;
        proxy_hide_header via;
        # proxy_hide_header age;
        # proxy_hide_header x-cache;

        # Add explicit vary header to improve cacheability
        # ================================================
        add_header Vary Accept-Encoding;
        # proxy_set_header Host dl.dropboxusercontent.com:443;
        set $download_url http://ledge.knownly.net:8280/$dropbox_path;
        #set $download_url https://dl.dropboxusercontent.com/$dropbox_path;
        proxy_pass $download_url;
        proxy_intercept_errors on;

        error_page 302 @404;
        error_page 404 @404;
        error_page 429 503 =307 @307;
    }

    location @307 {
        root /;
        try_files /sites/knownly/static/307_user_website_429_503.html =307;
        expires 30d;
        add_header Cache-Control "public";
        #add_header Pragma public;
    }

    location @404 {
         root /;
         try_files /sites/knownly/static/404_user_website.html =404;
         expires 30d;
         add_header Cache-Control "public";
         #add_header Pragma public;
    }
}

